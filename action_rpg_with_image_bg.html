<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action RPG - 画像背景版</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a2e;
            font-family: 'Arial', sans-serif;
        }
        
        .game-container {
            text-align: center;
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        
        .canvas-wrapper {
            position: relative;
            display: inline-block;
        }
        
        #bgCanvas {
            position: absolute;
            top: 0;
            left: 0;
            border: 3px solid #0f4c75;
        }
        
        #gameCanvas {
            position: relative;
            border: 3px solid #0f4c75;
            cursor: crosshair;
        }
        
        .image-upload {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #0f3460;
            border-radius: 5px;
        }
        
        .image-upload input[type="file"] {
            margin-right: 10px;
        }
        
        .image-controls button {
            margin: 0 5px;
            padding: 5px 10px;
            background-color: #e94560;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        
        .image-controls button:hover {
            background-color: #d63652;
        }
        
        .info {
            color: #ecf0f1;
            margin-top: 15px;
        }
        
        .controls {
            margin-top: 10px;
            color: #bdc3c7;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            color: #ecf0f1;
        }
        
        h1 {
            color: #e94560;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Action RPG - 背景画像対応版</h1>
        
        <div class="image-upload">
            <input type="file" id="imageInput" accept="image/*">
            <span class="image-controls">
                <button onclick="loadDefaultBg()">デフォルト背景</button>
                <button onclick="clearBg()">背景クリア</button>
                <span style="color: #ecf0f1; margin-left: 10px;">透明度:</span>
                <input type="range" id="opacitySlider" min="0" max="100" value="30" style="width: 100px;">
                <span id="opacityValue" style="color: #ecf0f1;">30%</span>
            </span>
        </div>
        
        <div class="canvas-wrapper">
            <canvas id="bgCanvas" width="800" height="600"></canvas>
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>
        
        <div class="info">
            <div class="controls">
                移動: 矢印キー/WASD | 攻撃: スペース | 特殊攻撃: E | ダッシュ: Shift
            </div>
            <div class="stats">
                <span>座標: <span id="position" style="color: #f39c12; font-weight: bold;">X:400 Y:300</span></span>
                <span>HP: <span id="hp">100/100</span></span>
                <span>MP: <span id="mp">50/50</span></span>
                <span>レベル: <span id="level">1</span></span>
                <span>スコア: <span id="score">0</span></span>
            </div>
        </div>
    </div>

    <script>
        console.log('[ACTION RPG] 背景画像対応版 - ゲーム初期化開始');
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const bgCanvas = document.getElementById('bgCanvas');
        const bgCtx = bgCanvas.getContext('2d');
        
        // 背景画像管理
        let bgImage = null;
        let bgOpacity = 0.3;
        
        // 画像アップロード処理
        document.getElementById('imageInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        bgImage = img;
                        drawBackground();
                        console.log('[ACTION RPG] 背景画像を読み込みました');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
        
        // 透明度スライダー
        document.getElementById('opacitySlider').addEventListener('input', function(e) {
            bgOpacity = e.target.value / 100;
            document.getElementById('opacityValue').textContent = e.target.value + '%';
            drawBackground();
        });
        
        // デフォルト背景
        function loadDefaultBg() {
            // グラデーション背景を作成
            bgImage = 'gradient';
            drawBackground();
        }
        
        // 背景クリア
        function clearBg() {
            bgImage = null;
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
        }
        
        // 背景描画
        function drawBackground() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
            bgCtx.globalAlpha = bgOpacity;
            
            if (bgImage === 'gradient') {
                // グラデーション背景
                const gradient = bgCtx.createLinearGradient(0, 0, bgCanvas.width, bgCanvas.height);
                gradient.addColorStop(0, '#1a1a2e');
                gradient.addColorStop(0.5, '#0f4c75');
                gradient.addColorStop(1, '#16213e');
                bgCtx.fillStyle = gradient;
                bgCtx.fillRect(0, 0, bgCanvas.width, bgCanvas.height);
            } else if (bgImage) {
                // 画像を canvas サイズに合わせて描画
                bgCtx.drawImage(bgImage, 0, 0, bgCanvas.width, bgCanvas.height);
            }
            
            bgCtx.globalAlpha = 1;
        }
        
        // ゲーム状態（前のゲームと同じ）
        const game = {
            player: {
                x: 400,
                y: 300,
                width: 32,
                height: 32,
                speed: 5,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                level: 1,
                score: 0,
                color: '#e94560',
                facing: 'right'
            },
            enemies: [],
            projectiles: [],
            particles: [],
            keys: {},
            frameCount: 0
        };
        
        // 簡易的な敵
        function spawnEnemy() {
            const enemy = {
                x: Math.random() * (canvas.width - 32),
                y: Math.random() * (canvas.height - 32),
                width: 32,
                height: 32,
                color: '#e74c3c',
                speed: 1 + Math.random() * 2
            };
            game.enemies.push(enemy);
        }
        
        // キー入力
        document.addEventListener('keydown', (e) => {
            game.keys[e.key] = true;
        });
        
        document.addEventListener('keyup', (e) => {
            game.keys[e.key] = false;
        });
        
        // アップデート
        function update() {
            // プレイヤー移動
            const speed = game.player.speed;
            
            if (game.keys['ArrowLeft'] || game.keys['a'] || game.keys['A']) {
                game.player.x = Math.max(0, game.player.x - speed);
                game.player.facing = 'left';
            }
            if (game.keys['ArrowRight'] || game.keys['d'] || game.keys['D']) {
                game.player.x = Math.min(canvas.width - game.player.width, game.player.x + speed);
                game.player.facing = 'right';
            }
            if (game.keys['ArrowUp'] || game.keys['w'] || game.keys['W']) {
                game.player.y = Math.max(0, game.player.y - speed);
                game.player.facing = 'up';
            }
            if (game.keys['ArrowDown'] || game.keys['s'] || game.keys['S']) {
                game.player.y = Math.min(canvas.height - game.player.height, game.player.y + speed);
                game.player.facing = 'down';
            }
            
            // 敵の移動（プレイヤーに向かって）
            game.enemies.forEach(enemy => {
                const dx = game.player.x - enemy.x;
                const dy = game.player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 0) {
                    enemy.x += (dx / dist) * enemy.speed;
                    enemy.y += (dy / dist) * enemy.speed;
                }
            });
            
            // パーティクル更新
            game.particles = game.particles.filter(p => {
                p.x += p.dx;
                p.y += p.dy;
                p.lifetime--;
                p.size *= 0.95;
                return p.lifetime > 0;
            });
            
            // UI更新
            updateUI();
            
            // 敵スポーン
            if (game.frameCount % 180 === 0) {
                spawnEnemy();
            }
            
            game.frameCount++;
        }
        
        // UI更新
        function updateUI() {
            document.getElementById('position').textContent = `X:${Math.round(game.player.x)} Y:${Math.round(game.player.y)}`;
            document.getElementById('hp').textContent = `${game.player.hp}/${game.player.maxHp}`;
            document.getElementById('mp').textContent = `${game.player.mp}/${game.player.maxMp}`;
            document.getElementById('level').textContent = game.player.level;
            document.getElementById('score').textContent = game.player.score;
        }
        
        // 描画
        function render() {
            // ゲーム画面クリア（透明にする）
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 半透明の暗いオーバーレイ（見やすさのため）
            ctx.fillStyle = 'rgba(15, 52, 96, 0.3)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // グリッド（オプション）
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // パーティクル
            game.particles.forEach(p => {
                ctx.globalAlpha = p.lifetime / 20;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
            });
            ctx.globalAlpha = 1;
            
            // 敵
            game.enemies.forEach(enemy => {
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                
                // 輪郭
                ctx.strokeStyle = '#fff';
                ctx.strokeRect(enemy.x, enemy.y, enemy.width, enemy.height);
            });
            
            // プレイヤー
            ctx.fillStyle = game.player.color;
            ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
            
            // プレイヤーの向き表示
            ctx.fillStyle = '#fff';
            switch(game.player.facing) {
                case 'up': 
                    ctx.fillRect(game.player.x + game.player.width/2 - 2, game.player.y, 4, 8);
                    break;
                case 'down':
                    ctx.fillRect(game.player.x + game.player.width/2 - 2, game.player.y + game.player.height - 8, 4, 8);
                    break;
                case 'left':
                    ctx.fillRect(game.player.x, game.player.y + game.player.height/2 - 2, 8, 4);
                    break;
                case 'right':
                    ctx.fillRect(game.player.x + game.player.width - 8, game.player.y + game.player.height/2 - 2, 8, 4);
                    break;
            }
        }
        
        // ゲームループ
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // 初期化
        console.log('[ACTION RPG] ゲーム開始 - 画像をアップロードして背景として使用できます');
        
        // デフォルトでグラデーション背景を表示
        loadDefaultBg();
        
        // 初期敵配置
        for (let i = 0; i < 3; i++) {
            spawnEnemy();
        }
        
        gameLoop();
    </script>
</body>
</html>