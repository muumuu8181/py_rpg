<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Action RPG - 攻撃システム搭載版</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a2e;
            font-family: 'Arial', sans-serif;
        }
        
        .game-container {
            text-align: center;
            background-color: #16213e;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
        }
        
        canvas {
            border: 3px solid #0f4c75;
            background-color: #0f3460;
            cursor: crosshair;
        }
        
        .info {
            color: #ecf0f1;
            margin-top: 15px;
        }
        
        .controls {
            margin-top: 10px;
            color: #bdc3c7;
            font-size: 14px;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
            color: #ecf0f1;
        }
        
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #0f0;
            font-family: monospace;
            font-size: 12px;
            padding: 10px;
            border-radius: 5px;
            max-width: 350px;
            max-height: 250px;
            overflow-y: auto;
        }
        
        h1 {
            color: #e94560;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>Action RPG - Battle System</h1>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="info">
            <div class="controls">
                移動: 矢印キー/WASD | 攻撃: スペース | 特殊攻撃: E | ダッシュ: Shift
            </div>
            <div class="stats">
                <span>座標: <span id="position" style="color: #f39c12; font-weight: bold;">X:400 Y:300</span></span>
                <span>HP: <span id="hp">100/100</span></span>
                <span>MP: <span id="mp">50/50</span></span>
                <span>レベル: <span id="level">1</span></span>
                <span>スコア: <span id="score">0</span></span>
                <span>コンボ: <span id="combo">0</span></span>
            </div>
        </div>
    </div>
    
    <div class="debug-panel" id="debugPanel">
        <div style="color: #fff; font-weight: bold;">Battle Log</div>
    </div>

    <script>
        console.log('[ACTION RPG] ゲーム初期化開始');
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // ゲーム状態
        const game = {
            player: {
                x: 400,
                y: 300,
                width: 32,
                height: 32,
                speed: 5,
                hp: 100,
                maxHp: 100,
                mp: 50,
                maxMp: 50,
                level: 1,
                score: 0,
                combo: 0,
                color: '#e94560',
                attackCooldown: 0,
                specialCooldown: 0,
                invincible: 0,
                facing: 'right',
                isDashing: false,
                dashCooldown: 0
            },
            enemies: [],
            projectiles: [],
            particles: [],
            items: [],
            keys: {},
            debugLogs: [],
            frameCount: 0,
            enemySpawnTimer: 0,
            waveNumber: 1
        };
        
        // 攻撃弾クラス
        class Projectile {
            constructor(x, y, dx, dy, damage = 10, owner = 'player') {
                this.x = x;
                this.y = y;
                this.dx = dx;
                this.dy = dy;
                this.damage = damage;
                this.owner = owner;
                this.size = owner === 'player' ? 8 : 6;
                this.color = owner === 'player' ? '#f39c12' : '#e74c3c';
                this.lifetime = 60;
            }
            
            update() {
                this.x += this.dx;
                this.y += this.dy;
                this.lifetime--;
                
                // パーティクル効果
                if (game.frameCount % 2 === 0) {
                    game.particles.push({
                        x: this.x,
                        y: this.y,
                        dx: (Math.random() - 0.5) * 2,
                        dy: (Math.random() - 0.5) * 2,
                        size: 3,
                        color: this.color,
                        lifetime: 10
                    });
                }
                
                return this.lifetime > 0 && 
                       this.x > 0 && this.x < canvas.width &&
                       this.y > 0 && this.y < canvas.height;
            }
            
            draw() {
                ctx.shadowBlur = 10;
                ctx.shadowColor = this.color;
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }
        
        // デバッグログ
        function battleLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[ACTION RPG] ${message}`);
            
            game.debugLogs.push({time: timestamp, msg: message, type: type});
            if (game.debugLogs.length > 15) {
                game.debugLogs.shift();
            }
            updateDebugPanel();
        }
        
        function updateDebugPanel() {
            const panel = document.getElementById('debugPanel');
            const logsHtml = game.debugLogs.map(log => {
                const color = log.type === 'damage' ? '#f00' : 
                             log.type === 'attack' ? '#f39c12' : 
                             log.type === 'special' ? '#9b59b6' : '#0f0';
                return `<div style="color: ${color}; font-size: 11px;">[${log.time}] ${log.msg}</div>`;
            }).join('');
            panel.innerHTML = '<div style="color: #fff; font-weight: bold;">Battle Log</div>' + logsHtml;
        }
        
        // 敵AI強化
        function spawnEnemy(type = 'normal') {
            const enemyTypes = {
                normal: { hp: 30, speed: 2, color: '#e74c3c', size: 28, score: 10 },
                fast: { hp: 20, speed: 4, color: '#f39c12', size: 24, score: 15 },
                tank: { hp: 60, speed: 1, color: '#9b59b6', size: 36, score: 25 },
                shooter: { hp: 25, speed: 2.5, color: '#3498db', size: 30, score: 20, canShoot: true }
            };
            
            const stats = enemyTypes[type] || enemyTypes.normal;
            const edge = Math.floor(Math.random() * 4);
            let x, y;
            
            switch(edge) {
                case 0: x = Math.random() * canvas.width; y = -30; break;
                case 1: x = canvas.width + 30; y = Math.random() * canvas.height; break;
                case 2: x = Math.random() * canvas.width; y = canvas.height + 30; break;
                case 3: x = -30; y = Math.random() * canvas.height; break;
            }
            
            const enemy = {
                x: x,
                y: y,
                width: stats.size,
                height: stats.size,
                hp: stats.hp,
                maxHp: stats.hp,
                speed: stats.speed,
                color: stats.color,
                score: stats.score,
                type: type,
                id: Date.now() + Math.random(),
                shootCooldown: 0,
                canShoot: stats.canShoot || false
            };
            
            game.enemies.push(enemy);
            battleLog(`${type}タイプの敵が出現！`, 'info');
        }
        
        // プレイヤー攻撃
        function playerAttack() {
            if (game.player.attackCooldown > 0) return;
            
            game.player.attackCooldown = 15;
            const speed = 12;
            
            // 向いている方向に弾を発射
            let dx = 0, dy = 0;
            switch(game.player.facing) {
                case 'up': dy = -speed; break;
                case 'down': dy = speed; break;
                case 'left': dx = -speed; break;
                case 'right': dx = speed; break;
            }
            
            game.projectiles.push(new Projectile(
                game.player.x + game.player.width / 2,
                game.player.y + game.player.height / 2,
                dx, dy, 10, 'player'
            ));
            
            battleLog('通常攻撃！', 'attack');
        }
        
        // 特殊攻撃（全方向）
        function specialAttack() {
            if (game.player.mp < 20 || game.player.specialCooldown > 0) return;
            
            game.player.mp -= 20;
            game.player.specialCooldown = 60;
            
            // 8方向に弾を発射
            for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 4) {
                const speed = 8;
                game.projectiles.push(new Projectile(
                    game.player.x + game.player.width / 2,
                    game.player.y + game.player.height / 2,
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed,
                    15, 'player'
                ));
            }
            
            battleLog('特殊攻撃発動！MP-20', 'special');
            
            // 画面揺れ効果
            canvas.style.animation = 'shake 0.3s';
            setTimeout(() => canvas.style.animation = '', 300);
        }
        
        // ダッシュ
        function dash() {
            if (game.player.dashCooldown > 0) return;
            
            game.player.isDashing = true;
            game.player.dashCooldown = 30;
            game.player.invincible = 10;
            
            battleLog('ダッシュ！', 'info');
        }
        
        // キー入力
        document.addEventListener('keydown', (e) => {
            game.keys[e.key] = true;
            
            if (e.key === ' ' || e.key === 'Space') {
                e.preventDefault();
                playerAttack();
            }
            if (e.key === 'e' || e.key === 'E') {
                e.preventDefault();
                specialAttack();
            }
            if (e.key === 'Shift') {
                e.preventDefault();
                dash();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            game.keys[e.key] = false;
            if (e.key === 'Shift') {
                game.player.isDashing = false;
            }
        });
        
        // 衝突判定
        function checkCollision(a, b) {
            return a.x < b.x + b.width &&
                   a.x + a.width > b.x &&
                   a.y < b.y + b.height &&
                   a.y + a.height > b.y;
        }
        
        // アップデート
        function update() {
            // プレイヤー移動
            const oldX = game.player.x;
            const oldY = game.player.y;
            const speed = game.player.isDashing ? game.player.speed * 2 : game.player.speed;
            
            if (game.keys['ArrowLeft'] || game.keys['a'] || game.keys['A']) {
                game.player.x = Math.max(0, game.player.x - speed);
                game.player.facing = 'left';
            }
            if (game.keys['ArrowRight'] || game.keys['d'] || game.keys['D']) {
                game.player.x = Math.min(canvas.width - game.player.width, game.player.x + speed);
                game.player.facing = 'right';
            }
            if (game.keys['ArrowUp'] || game.keys['w'] || game.keys['W']) {
                game.player.y = Math.max(0, game.player.y - speed);
                game.player.facing = 'up';
            }
            if (game.keys['ArrowDown'] || game.keys['s'] || game.keys['S']) {
                game.player.y = Math.min(canvas.height - game.player.height, game.player.y + speed);
                game.player.facing = 'down';
            }
            
            // 移動をログ記録（10フレームごと）
            if ((oldX !== game.player.x || oldY !== game.player.y) && game.frameCount % 10 === 0) {
                battleLog(`移動: (${Math.round(oldX)},${Math.round(oldY)}) → (${Math.round(game.player.x)},${Math.round(game.player.y)})`, 'info');
            }
            
            // クールダウン更新
            if (game.player.attackCooldown > 0) game.player.attackCooldown--;
            if (game.player.specialCooldown > 0) game.player.specialCooldown--;
            if (game.player.dashCooldown > 0) game.player.dashCooldown--;
            if (game.player.invincible > 0) game.player.invincible--;
            
            // MP回復
            if (game.frameCount % 30 === 0 && game.player.mp < game.player.maxMp) {
                game.player.mp++;
            }
            
            // 弾の更新
            game.projectiles = game.projectiles.filter(proj => {
                if (!proj.update()) return false;
                
                // 敵との衝突判定
                if (proj.owner === 'player') {
                    for (let enemy of game.enemies) {
                        if (Math.abs(proj.x - (enemy.x + enemy.width/2)) < enemy.width/2 &&
                            Math.abs(proj.y - (enemy.y + enemy.height/2)) < enemy.height/2) {
                            enemy.hp -= proj.damage;
                            
                            // ヒットエフェクト
                            for (let i = 0; i < 10; i++) {
                                game.particles.push({
                                    x: proj.x,
                                    y: proj.y,
                                    dx: (Math.random() - 0.5) * 5,
                                    dy: (Math.random() - 0.5) * 5,
                                    size: 5,
                                    color: enemy.color,
                                    lifetime: 20
                                });
                            }
                            
                            if (enemy.hp <= 0) {
                                game.player.score += enemy.score;
                                game.player.combo++;
                                battleLog(`敵撃破！+${enemy.score}点 コンボ:${game.player.combo}`, 'attack');
                                
                                // 経験値
                                if (game.player.score >= game.player.level * 100) {
                                    game.player.level++;
                                    game.player.hp = game.player.maxHp;
                                    game.player.mp = game.player.maxMp;
                                    battleLog(`レベルアップ！Lv${game.player.level}`, 'special');
                                }
                            } else {
                                battleLog(`敵にダメージ！残HP:${enemy.hp}`, 'attack');
                            }
                            
                            return false;
                        }
                    }
                }
                
                // プレイヤーとの衝突判定
                if (proj.owner === 'enemy' && game.player.invincible === 0) {
                    if (Math.abs(proj.x - (game.player.x + game.player.width/2)) < game.player.width/2 &&
                        Math.abs(proj.y - (game.player.y + game.player.height/2)) < game.player.height/2) {
                        game.player.hp -= proj.damage;
                        game.player.invincible = 30;
                        game.player.combo = 0;
                        battleLog(`被ダメージ！HP:${game.player.hp}`, 'damage');
                        return false;
                    }
                }
                
                return true;
            });
            
            // 敵の更新
            game.enemies = game.enemies.filter(enemy => {
                if (enemy.hp <= 0) {
                    // アイテムドロップ
                    if (Math.random() < 0.3) {
                        game.items.push({
                            x: enemy.x,
                            y: enemy.y,
                            width: 20,
                            height: 20,
                            type: Math.random() < 0.7 ? 'hp' : 'mp',
                            color: Math.random() < 0.7 ? '#2ecc71' : '#3498db'
                        });
                    }
                    return false;
                }
                
                // プレイヤーに向かって移動
                const dx = game.player.x - enemy.x;
                const dy = game.player.y - enemy.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                
                if (dist > 0) {
                    enemy.x += (dx / dist) * enemy.speed;
                    enemy.y += (dy / dist) * enemy.speed;
                }
                
                // 射撃タイプの敵
                if (enemy.canShoot && enemy.shootCooldown <= 0 && dist < 300) {
                    enemy.shootCooldown = 60;
                    const bulletSpeed = 5;
                    game.projectiles.push(new Projectile(
                        enemy.x + enemy.width / 2,
                        enemy.y + enemy.height / 2,
                        (dx / dist) * bulletSpeed,
                        (dy / dist) * bulletSpeed,
                        5, 'enemy'
                    ));
                }
                if (enemy.shootCooldown > 0) enemy.shootCooldown--;
                
                // プレイヤーとの接触ダメージ
                if (checkCollision(game.player, enemy) && game.player.invincible === 0) {
                    game.player.hp -= 5;
                    game.player.invincible = 30;
                    game.player.combo = 0;
                    battleLog(`接触ダメージ！HP:${game.player.hp}`, 'damage');
                }
                
                return true;
            });
            
            // アイテム取得
            game.items = game.items.filter(item => {
                if (checkCollision(game.player, item)) {
                    if (item.type === 'hp') {
                        game.player.hp = Math.min(game.player.maxHp, game.player.hp + 20);
                        battleLog('HP回復！+20', 'info');
                    } else {
                        game.player.mp = Math.min(game.player.maxMp, game.player.mp + 10);
                        battleLog('MP回復！+10', 'info');
                    }
                    return false;
                }
                return true;
            });
            
            // パーティクル更新
            game.particles = game.particles.filter(p => {
                p.x += p.dx;
                p.y += p.dy;
                p.lifetime--;
                p.size *= 0.95;
                return p.lifetime > 0;
            });
            
            // 敵スポーン
            game.enemySpawnTimer++;
            if (game.enemySpawnTimer > 120 - game.waveNumber * 10) {
                game.enemySpawnTimer = 0;
                const types = ['normal', 'fast', 'tank', 'shooter'];
                const type = types[Math.floor(Math.random() * types.length)];
                spawnEnemy(type);
                
                // ウェーブ進行
                if (game.enemies.length === 0 && game.frameCount > 300) {
                    game.waveNumber++;
                    battleLog(`ウェーブ${game.waveNumber}開始！`, 'special');
                }
            }
            
            // ゲームオーバー
            if (game.player.hp <= 0) {
                battleLog('ゲームオーバー！', 'damage');
                console.error('[ACTION RPG] GAME OVER - スコア:', game.player.score);
                resetGame();
            }
            
            // UI更新
            updateUI();
            game.frameCount++;
        }
        
        // UI更新
        function updateUI() {
            document.getElementById('position').textContent = `X:${Math.round(game.player.x)} Y:${Math.round(game.player.y)}`;
            document.getElementById('hp').textContent = `${game.player.hp}/${game.player.maxHp}`;
            document.getElementById('mp').textContent = `${game.player.mp}/${game.player.maxMp}`;
            document.getElementById('level').textContent = game.player.level;
            document.getElementById('score').textContent = game.player.score;
            document.getElementById('combo').textContent = `x${game.player.combo}`;
        }
        
        // 描画
        function render() {
            // 背景
            ctx.fillStyle = '#0f3460';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // グリッド
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            for (let x = 0; x < canvas.width; x += 50) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            for (let y = 0; y < canvas.height; y += 50) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
            
            // アイテム
            game.items.forEach(item => {
                ctx.fillStyle = item.color;
                ctx.fillRect(item.x, item.y, item.width, item.height);
                ctx.fillStyle = '#fff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(item.type.toUpperCase(), item.x + item.width/2, item.y + item.height/2 + 4);
            });
            
            // パーティクル
            game.particles.forEach(p => {
                ctx.globalAlpha = p.lifetime / 20;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.size/2, p.y - p.size/2, p.size, p.size);
            });
            ctx.globalAlpha = 1;
            
            // 弾
            game.projectiles.forEach(proj => proj.draw());
            
            // 敵
            game.enemies.forEach(enemy => {
                // 本体
                ctx.fillStyle = enemy.color;
                ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                
                // HPバー
                const hpPercent = enemy.hp / enemy.maxHp;
                ctx.fillStyle = '#e74c3c';
                ctx.fillRect(enemy.x, enemy.y - 10, enemy.width * hpPercent, 4);
                ctx.strokeStyle = '#fff';
                ctx.strokeRect(enemy.x, enemy.y - 10, enemy.width, 4);
                
                // タイプ表示
                ctx.fillStyle = '#fff';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(enemy.type[0].toUpperCase(), enemy.x + enemy.width/2, enemy.y + enemy.height/2 + 3);
            });
            
            // プレイヤー
            if (game.player.invincible % 4 < 2) { // 点滅効果
                ctx.fillStyle = game.player.color;
                ctx.fillRect(game.player.x, game.player.y, game.player.width, game.player.height);
                
                // 向き表示
                ctx.fillStyle = '#fff';
                switch(game.player.facing) {
                    case 'up': 
                        ctx.fillRect(game.player.x + game.player.width/2 - 2, game.player.y, 4, 8);
                        break;
                    case 'down':
                        ctx.fillRect(game.player.x + game.player.width/2 - 2, game.player.y + game.player.height - 8, 4, 8);
                        break;
                    case 'left':
                        ctx.fillRect(game.player.x, game.player.y + game.player.height/2 - 2, 8, 4);
                        break;
                    case 'right':
                        ctx.fillRect(game.player.x + game.player.width - 8, game.player.y + game.player.height/2 - 2, 8, 4);
                        break;
                }
            }
        }
        
        // ゲームリセット
        function resetGame() {
            game.player.hp = game.player.maxHp;
            game.player.mp = game.player.maxMp;
            game.player.x = 400;
            game.player.y = 300;
            game.player.level = 1;
            game.player.score = 0;
            game.player.combo = 0;
            game.enemies = [];
            game.projectiles = [];
            game.items = [];
            game.waveNumber = 1;
            
            battleLog('ゲームリセット', 'info');
            
            // 初期敵配置
            for (let i = 0; i < 3; i++) {
                setTimeout(() => spawnEnemy('normal'), i * 1000);
            }
        }
        
        // CSS アニメーション
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translate(0, 0); }
                25% { transform: translate(-5px, 0); }
                50% { transform: translate(5px, 0); }
                75% { transform: translate(0, -5px); }
            }
        `;
        document.head.appendChild(style);
        
        // ゲームループ
        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        
        // 初期化
        battleLog('Action RPG 起動！', 'info');
        console.log('[ACTION RPG] 操作方法: 矢印キーで移動、スペースで攻撃、Eで特殊攻撃');
        
        // 初期敵配置
        setTimeout(() => spawnEnemy('normal'), 1000);
        setTimeout(() => spawnEnemy('fast'), 2000);
        setTimeout(() => spawnEnemy('tank'), 3000);
        
        gameLoop();
        
        // 定期ステータスログ
        setInterval(() => {
            console.log(`[ACTION RPG] Wave:${game.waveNumber} Score:${game.player.score} 敵:${game.enemies.length} 弾:${game.projectiles.length}`);
        }, 5000);
    </script>
</body>
</html>